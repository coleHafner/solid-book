<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Working with promises | The Big Incomplete Book of Dev</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.5.2">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../../../../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../../../../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../../../book/project/beta-testing/index.html" />
    
    
    <link rel="prev" href="../../../../book/project/workflow/debugging/php/index.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="2.3" data-chapter-title="Working with promises" data-filepath="book/project/workflow/concepts/README.md" data-basepath="../../../.." data-revision="Mon Apr 04 2016 07:50:20 GMT-0700 (PDT)">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="book/project/setup/index.html">
            
                
                    <a href="../../../../book/project/setup/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Setting up a project
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="book/project/setup/architecture/index.html">
            
                
                    <a href="../../../../book/project/setup/architecture/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Architecture
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="book/project/setup/architecture/scaffolding/index.html">
            
                
                    <a href="../../../../book/project/setup/architecture/scaffolding/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.1.</b>
                        
                        Scaffolding
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="book/project/setup/architecture/runtime-environments/index.html">
            
                
                    <a href="../../../../book/project/setup/architecture/runtime-environments/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.2.</b>
                        
                        Runtime Environments
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="book/project/setup/provisioning/index.html">
            
                
                    <a href="../../../../book/project/setup/provisioning/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Provisioning
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="book/project/setup/provisioning/ansible/index.html">
            
                
                    <a href="../../../../book/project/setup/provisioning/ansible/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.1.</b>
                        
                        Ansible Intro
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="book/project/setup/provisioning/ansible/playbooks/index.html">
            
                
                    <a href="../../../../book/project/setup/provisioning/ansible/playbooks/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.2.</b>
                        
                        Initial setup
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="book/project/setup/provisioning/ansible/roles/index.html">
            
                
                    <a href="../../../../book/project/setup/provisioning/ansible/roles/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.3.</b>
                        
                        Creating roles
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="book/project/workflow/index.html">
            
                
                    <a href="../../../../book/project/workflow/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Project Workflow
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="book/project/workflow/debugging/node/index.html">
            
                
                    <a href="../../../../book/project/workflow/debugging/node/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Debugging Node
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="book/project/workflow/debugging/php/index.html">
            
                
                    <a href="../../../../book/project/workflow/debugging/php/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Debugging PHP
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.3" data-path="book/project/workflow/concepts/index.html">
            
                
                    <a href="../../../../book/project/workflow/concepts/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Working with promises
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="book/project/beta-testing/index.html">
            
                
                    <a href="../../../../book/project/beta-testing/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Beta Testing
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.4.1" data-path="book/project/beta-testing/ios/testflight/index.html">
            
                
                    <a href="../../../../book/project/beta-testing/ios/testflight/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.1.</b>
                        
                        TestFlight-iOS
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4.2" data-path="book/project/beta-testing/android/testfairy/index.html">
            
                
                    <a href="../../../../book/project/beta-testing/android/testfairy/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.2.</b>
                        
                        TestFairy-Android
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="book/project/development/index.html">
            
                
                    <a href="../../../../book/project/development/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Project Development
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="book/project/development/node/index.html">
            
                
                    <a href="../../../../book/project/development/node/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Node
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="book/project/development/node/app/index.html">
            
                
                    <a href="../../../../book/project/development/node/app/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.1.</b>
                        
                        What &quot;good&quot; node apps should have
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="book/project/deployment/index.html">
            
                
                    <a href="../../../../book/project/deployment/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Deploying a project
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="book/project/deployment/build/index.html">
            
                
                    <a href="../../../../book/project/deployment/build/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Deployment build script for static webpage
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="general/misc/index.html">
            
                
                    <a href="../../../../general/misc/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Misc
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1" data-path="general/error-handling/exponential-backoff/index.html">
            
                
                    <a href="../../../../general/error-handling/exponential-backoff/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                        Exponential Back Off
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="general/error-handling/javascript/index.html">
            
                
                    <a href="../../../../general/error-handling/javascript/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                        JavaScript
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="general/file-upload/index.html">
            
                
                    <a href="../../../../general/file-upload/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.3.</b>
                        
                        File Upload
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="general/profiling/index.html">
            
                
                    <a href="../../../../general/profiling/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.4.</b>
                        
                        Profiling
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="general/version-control/index.html">
            
                
                    <a href="../../../../general/version-control/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.5.</b>
                        
                        Version Control
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="general/security/index.html">
            
                
                    <a href="../../../../general/security/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.6.</b>
                        
                        Security
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.7" data-path="detail/elasticsearch/index.html">
            
                
                    <a href="../../../../detail/elasticsearch/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.7.</b>
                        
                        Elasticsearch
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.8" data-path="detail/fastcgi/index.html">
            
                
                    <a href="../../../../detail/fastcgi/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.8.</b>
                        
                        FastCgi
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.9" data-path="detail/form/index.html">
            
                
                    <a href="../../../../detail/form/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.9.</b>
                        
                        Form
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.10" data-path="detail/git/gitflow/index.html">
            
                
                    <a href="../../../../detail/git/gitflow/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.10.</b>
                        
                        Gitflow
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.11" data-path="detail/git/hooks/index.html">
            
                
                    <a href="../../../../detail/git/hooks/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.11.</b>
                        
                        Hooks
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.12" data-path="detail/javascript/es6/index.html">
            
                
                    <a href="../../../../detail/javascript/es6/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.12.</b>
                        
                        es6
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.13" data-path="detail/mongo/users/index.html">
            
                
                    <a href="../../../../detail/mongo/users/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.13.</b>
                        
                        Users
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.14" data-path="detail/mysql/profiling/index.html">
            
                
                    <a href="../../../../detail/mysql/profiling/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.14.</b>
                        
                        Profiling
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.15" data-path="detail/mysql/users/index.html">
            
                
                    <a href="../../../../detail/mysql/users/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.15.</b>
                        
                        Users
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.16" data-path="detail/nginx/config/index.html">
            
                
                    <a href="../../../../detail/nginx/config/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.16.</b>
                        
                        Config
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.17" data-path="detail/nginx/fastcgi-cache/index.html">
            
                
                    <a href="../../../../detail/nginx/fastcgi-cache/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.17.</b>
                        
                        Fastcgi cache
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.18" data-path="detail/php/mysql-extension/index.html">
            
                
                    <a href="../../../../detail/php/mysql-extension/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.18.</b>
                        
                        Mysql extension
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.19" data-path="detail/shell/cli/index.html">
            
                
                    <a href="../../../../detail/shell/cli/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.19.</b>
                        
                        CLI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.20" data-path="detail/shell/commands/index.html">
            
                
                    <a href="../../../../detail/shell/commands/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.20.</b>
                        
                        Commands
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../../../" >The Big Incomplete Book of Dev</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="working-with-promises">Working with promises</h1>
<p>Bluebird has a good section on anti patterns.</p>
<p>In general your then blocks should be small. Functions should return promises vs
passing promise chains in to functions, and the modification of the context should
always be at the same level of visibility as the bind. Specifics below:</p>
<h2 id="return-a-promise">Return a promise</h2>
<p>If your functions return a promise, it is easy to reuse them.</p>
<pre><code class="lang-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doWork</span>(<span class="hljs-params">work</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BB(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>)) </span>{
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      resolve(<span class="hljs-string">&apos;done with &apos;</span> + work);
    }, <span class="hljs-number">500</span>);
  }
}
</code></pre>
<p>Now you can create more async functions out of this:</p>
<pre><code class="lang-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doMuchWork</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> BB.all([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>].map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">work</span>) </span>{
    <span class="hljs-keyword">return</span> doWork(work);
  }));
}
</code></pre>
<p>This enables a clear control flow:</p>
<pre><code class="lang-javascript">BB
  .try(doMuchWork)
  .then(doMuchMoreWork);
</code></pre>
<p>The antipattern to this is passing in promise chains that get added to:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// this is brittle and hard to modularize</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doWork</span>(<span class="hljs-params">work, promises</span>) </span>{
  promises.push(doSomething(work));
  <span class="hljs-keyword">return</span> promises;
}
</code></pre>
<h2 id="modify-the-context-at-one-level-of-visibility">Modify the context at one level of visibility</h2>
<p>BB has a very useful method called bind:</p>
<pre><code class="lang-javascript">BB
  .bind({
    name : <span class="hljs-string">&apos;ratatat&apos;</span>
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.name); <span class="hljs-comment">// ratatat</span>
  });
</code></pre>
<p>The context is useful for building up a complex compound result, but the context
can become difficult to manage. To ease in its management, do not hide it&apos;s modification,
but modify it at the same level of visibility as it is bound:</p>
<pre><code class="lang-javascript">BB
    .bind({
      id : <span class="hljs-string">&apos;abc&apos;</span>,
      name : <span class="hljs-literal">null</span>
    })
    .then(getName)
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
      <span class="hljs-keyword">this</span>.name = name;
    })
    .then(returnResult);
</code></pre>
<p>The above is much easier to debug than having <code>this.name = name</code> inside the <code>getName</code>
function.</p>
<p>It is important to keep in mind that newly create chains are unbound so you have to rebind them:</p>
<pre><code class="lang-javascript">BB
  .bind({
    name:<span class="hljs-string">&apos;jane&apos;</span>
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

      <span class="hljs-comment">// Creating a new chain, so you have to bind it</span>
      <span class="hljs-keyword">return</span> BB
        .bind(<span class="hljs-keyword">this</span>)
        .then(doSomething);
  });
</code></pre>
<h2 id="start-chains-with-a-function-reference">Start chains with a function reference</h2>
<p>If you start a chain with a function call, then synchronous errors in that function
are not caugh by the promise, so use a function reference:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// errors from functionReference will be caught by BB</span>
BB
    .try(functionReference)
    .then(...)

<span class="hljs-comment">// functionReference will through synchronous errors</span>
functionReference()
    .then()
</code></pre>
<h2 id="use-join-if-you-know-how-many-promises-you-have">Use join if you know how many promises you have:</h2>
<p>Note that the last function is the callback:</p>
<pre><code class="lang-javascript">BB.join(getNames(), getNumbers(), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, numbers</span>) </span>{

  });
</code></pre>
<p>Combining BB with array / lodash methods can be very expressive:</p>
<h2 id="try-to-keep-the-control-flow-as-unified-as-possible-and-break-out-the-async-work">Try to keep the control flow as unified as possible, and break out the async work</h2>
<p>This often make future modifications and debugging easier. It keeps function logic separate
from control flow.</p>
<pre><code class="lang-javascript">BB.try(getPartOne)
  .then(getPartTwo)
  .then(getPartThree)
  .then(assembleParts);
</code></pre>
<p>vs making a method call called <code>getParts</code> which chains the different get part calls.</p>
<h2 id="try-to-have-as-few-catches-as-possible-with-specific-throws">Try to have as few catches as possible with specific throws</h2>
<pre><code class="lang-javascript">BB.try(getPartOne)
  .then(getPartTwo)
  .then(getPartThree)
  .catch();
</code></pre>
<p>vs having a catch in each get part. Remember if you do have a catch in each part, the
chain will keep going on an error and not terminate:</p>
<pre><code class="lang-javascript">BB.try(getPartOne)
  .then(getPartTwo)
  .then(getPartThree)
  .catch();

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPartOne</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> BB.try(...)
      .catch();
  }
</code></pre>
<p>is equal to:</p>
<pre><code class="lang-javascript">BB.try(getPartOne)
  .catch(...)
  .then(getPartTwo)
  .then(getPartThree)
  .catch();
</code></pre>
<p>so, you&apos;ll always get to getPartTwo.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../../../book/project/workflow/debugging/php/index.html" class="navigation navigation-prev " aria-label="Previous page: Debugging PHP"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../../../book/project/beta-testing/index.html" class="navigation navigation-next " aria-label="Next page: Beta Testing"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../../../gitbook/app.js"></script>

    
    <script src="../../../../gitbook/plugins/gitbook-plugin-jsfiddle/plugin.js"></script>
    

    
    <script src="../../../../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../../../../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../../../../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../../../../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"jsfiddle":{"tabs":["result","js","css","html"],"height":500,"width":500},"highlight":{},"search":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
